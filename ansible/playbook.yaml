---
# ------------------------------------
# 1. Configure Web Tier (Nginx)
# ------------------------------------
- name: Configure Web Server
  hosts: webservers
  become: yes
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Nginx
      apt:
        name: nginx
        state: present

    - name: Start and Enable Nginx
      service:
        name: nginx
        state: started
        enabled: yes

# ------------------------------------
# 2. Configure App Tier (Tomcat)
# ------------------------------------
- name: Configure App Server
  hosts: appservers
  become: yes
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Java (Required for Tomcat)
      apt:
        name: default-jdk
        state: present

    - name: Install Tomcat 9
      apt:
        name: tomcat9
        state: present

    - name: Start and Enable Tomcat
      service:
        name: tomcat9
        state: started
        enabled: yes

# ------------------------------------
# 3. Configure DB Tier (MySQL)
# ------------------------------------
- name: Configure DB Server
  hosts: dbservers
  become: yes
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install MySQL Server
      apt:
        name: mysql-server
        state: present

    - name: Start and Enable MySQL
      service:
        name: mysql
        state: started
        enabled: yes

    - name: Allow remote connections to MySQL
      # Changes bind-address from 127.0.0.1 to 0.0.0.0 so the App VM can connect
      lineinfile:
        path: /etc/mysql/mysql.conf.d/mysqld.cnf
        regexp: "^bind-address"
        line: "bind-address = 0.0.0.0"
      notify: Restart MySQL

  handlers:
    - name: Restart MySQL
      service:
        name: mysql
        state: restarted
